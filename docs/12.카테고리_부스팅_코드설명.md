# 12. 카테고리 부스팅 코드 설명

이 문서는 `search.categoryboost` 패키지의 코드 역할과 연관관계를 빠르게 파악하기 위한 안내서입니다.
구현 디테일(동시성, 캐시, AS-IS/TO-BE 비교)은 패키지 내부 md 문서 링크로 분리했습니다.

## 1) 패키지 구조 한눈에 보기

대상 패키지:
- `src/main/java/com/example/aisearch/service/search/categoryboost`

하위 구성:
- `api`
- `policy`
- `store`

핵심 파일:
- `api/CategoryBoostRules.java`
- `api/CategoryBoostRulesReloader.java`
- `policy/CategoryBoostingDecider.java`
- `policy/CategoryBoostingResult.java`
- `store/JsonCategoryBoostRules.java`

## 2) 각 영역의 책임과 연결

### `api`: 기능 계약(인터페이스)

`CategoryBoostRules`
- 역할: "검색어를 넣으면 해당 검색어의 카테고리 부스팅 맵을 반환"하는 읽기 계약
- 메서드: `findByKeyword(String keyword)`

`CategoryBoostRulesReloader`
- 역할: 룰 데이터를 외부 신호로 재로딩하는 계약
- 메서드: `reload()`

의미:
- 비즈니스 정책(`policy`)은 인터페이스만 보고 동작합니다.
- 룰 저장 방식(JSON, DB, 원격 API)이 바뀌어도 정책 코드를 최소 수정으로 유지할 수 있습니다.

### `policy`: 부스팅 적용 여부 결정

`CategoryBoostingDecider`
- 입력: `SearchRequest`
- 출력: `CategoryBoostingResult`
- 역할: "부스팅을 적용할지", "최종 정렬은 무엇인지"를 결정

`CategoryBoostingResult`
- `applyCategoryBoost`: 부스팅 점수 적용 여부
- `searchSortOption`: 최종 정렬 옵션
- `categoryBoostById`: 카테고리 ID(String) -> 부스팅 점수(Double)
- 팩토리 메서드:
1. `withoutBoost(...)`
2. `withBoost(...)`

### `store`: 룰 데이터 저장/로딩

`JsonCategoryBoostRules`
- 역할: JSON 파일(`category_boosting.json`)에서 룰을 로드하고 캐시
- 구현 인터페이스:
1. `CategoryBoostRules` (조회)
2. `CategoryBoostRulesReloader` (재로딩)

## 3) 클래스 연관관계

요약 관계:
1. `KnnSearchStrategy` -> `CategoryBoostingDecider` 호출
2. `CategoryBoostingDecider` -> `CategoryBoostRules` 인터페이스 의존
3. `JsonCategoryBoostRules` -> `CategoryBoostRules`, `CategoryBoostRulesReloader` 구현
4. `CategoryBoostingResult` -> 전략 계층에 "적용 여부 + 정렬 + boost map" 전달

## 4) 왜 이렇게 분리했는가?

장점:
1. 정책(`policy`)과 저장소(`store`) 분리로 변경 영향이 작음
2. 룰 저장소 구현을 교체하기 쉬움(JSON -> DB 전환 가능)
3. 테스트가 쉬움:
   - 정책 테스트: `CategoryBoostRules`를 스텁으로 주입
   - 저장소 테스트: JSON 로딩/재로딩 자체 검증

## 5) 학습 순서 추천

처음 보는 개발자라면 아래 순서로 읽는 것을 권장합니다.

1. `CategoryBoostingDecider.java`  
2. `CategoryBoostingResult.java`  
3. `JsonCategoryBoostRules.java`  
4. 테스트 코드
- `CategoryBoostingDeciderTest`
- `JsonCategoryBoostRulesTest`

## 6) 패키지 내부 교육 문서 연결

아래 문서는 이 패키지를 더 깊게 이해할 때 바로 이어서 읽으면 좋습니다.

1. AtomicReference 중심 설명  
`src/main/java/com/example/aisearch/service/search/categoryboost/store/JsonCategoryBoostRules_AtomicReference.md`

2. 함수형 인터페이스(Supplier) AS-IS/TO-BE 비교  
`src/main/java/com/example/aisearch/service/search/categoryboost/store/Functional_Interface_Suplier.md`

추천 읽기 순서:
1. 이 문서(구조/흐름)
2. `JsonCategoryBoostRules_AtomicReference.md` (동시성/캐시 이해)
3. `Functional_Interface_Suplier.md` (설계 변경 의도 이해)
