# 07. 동의어 처리 가이드 🍜

<!-- DOC_STYLE_GUIDE -->
> 📌 <font color="#FFD700"><b>핵심</b></font>: 이 문서는 실무 적용 기준으로 정리되었습니다.
> ⚠️ <font color="red"><b>주의</b></font>: 설정/절차를 생략하면 장애나 품질 저하가 발생할 수 있습니다.
> ✅ <font color="green"><b>권장</b></font>: 체크리스트 순서대로 실행하고 결과를 반드시 검증하세요.

이 문서는 이 프로젝트에서 동의어를 어떻게 등록/적용하는지, 그리고 왜 그렇게 구현했는지를 초보 개발자도 이해할 수 있도록 설명합니다.  
핵심은 **파일 관리 + API 반영 + 검색 analyzer 재로드**입니다.

> [!NOTE]
> 운영 절차 3줄 요약
> 1) 동의어 파일 수정  
> 2) `POST /api/search/reload-synonyms` 호출  
> 3) 대표 검색어로 결과 확인

## 0. Elasticsearch 동의어 기능 소개 📘

Elasticsearch에서 동의어는 "사용자가 입력한 단어를 같은 의미의 다른 단어로 확장"해 검색 정확도를 높이는 기능입니다.

### 예시
- 사용자가 `교자`를 검색
- 동의어 규칙이 `만두, 교자, 얇은피, 얄피`로 등록되어 있으면
- `만두` 관련 상품도 함께 검색될 수 있습니다.

### 핵심 개념 요약

| 개념 | 설명 |
|---|---|
| `synonym` / `synonym_graph` | 검색어를 동의어로 확장하는 분석기 필터 |
| `search_analyzer` | 검색 시점에 사용하는 analyzer |
| `synonyms_set` | Elasticsearch에 저장되는 동의어 규칙 세트 |
| `_reload_search_analyzers` | 앱 재시작 없이 analyzer를 다시 로드하는 API |

### 동의어 적용 시점 2가지

| 방식 | 설명 | 장단점                                                                                                                                |
|---|---|------------------------------------------------------------------------------------------------------------------------------------|
| `index-time` | 문서를 색인할 때 동의어를 적용 | 검색은 빠르지만, 규칙 변경 시 재색인이 필요  <br> - 검색 QPS가 높고(예: 수백~수천+/sec) <br> - p95/p99 지연시간 목표가 매우 빡빡하고(예: <100ms) <br> - 동의어 규칙이 매우 크고 복잡할 때  |
| `search-time` | 사용자가 검색할 때 동의어를 적용 | 운영 반영이 빠르고 재색인 부담이 적음 <br>   - 10만 ~ 수백만 문서: search-time 충분히 일반적                                                                   |

### 왜 `search-time`으로 쓰는가? ✅
- <font color="green"><b>동의어를 바꿀 때 재색인 비용을 줄일 수 있습니다.</b></font>
- 운영 중에도 빠르게 규칙을 반영하기 좋습니다.





## 0.1 이 프로젝트의 적용 방식(API 기반) ⚙️

이 프로젝트는 "파일 수정 -> API 반영" 방식입니다.

1. 운영자가 동의어 파일을 관리
   - `synonyms_ko.txt`(운영)
   - `synonyms_kr_regression.txt`(회귀 테스트)
2. `POST /api/search/reload-synonyms` 호출
3. 서버가 파일을 읽어 `PUT /_synonyms/{setId}`로 ES에 반영
4. 서버가 `POST /{read-alias}/_reload_search_analyzers` 호출
5. 다음 검색 요청부터 동의어가 적용된 결과 반환

### 장점
- 배포/재기동 없이 반영 가능
- 운영 규칙과 회귀 테스트 규칙을 mode로 분리 가능
- 동의어 원본 파일(Source of Truth)을 Git으로 관리 가능

> [!IMPORTANT]
> `mode`는 ES에 저장되는 값이 아닙니다.  
> **어떤 파일을 읽을지 결정하는 애플리케이션 내부 분기값**입니다.

## 1. 한눈에 보기 🧭

- 동의어 원본은 파일 2개로 관리합니다.
  - 운영: `src/main/resources/es/dictionary/synonyms_ko.txt`
  - 회귀 테스트: `src/main/resources/es/dictionary/synonyms_kr_regression.txt`
- API `POST /api/search/reload-synonyms`를 호출하면 파일 내용을 Elasticsearch `synonyms_set`으로 반영합니다.
- `mode`는 ES에 저장되는 값이 아니라, 어떤 파일을 읽을지 결정하는 앱 내부 분기값입니다.
  - `PRODUCTION` -> 운영 파일
  - `REGRESSION` -> 회귀 파일

## 2. 왜 mode가 필요한가 🤔

운영 동의어와 테스트 동의어를 빠르게 전환하려고 사용합니다.

예시:
- 운영 중에는 `만두, 교자, 얇은피, 얄피`를 사용
- 회귀 검증 시에는 `만두, 떡국`으로 잠깐 바꿔서 `떡국` 검색 시 만두 계열이 나오는지 검증
- 검증 후 다시 `PRODUCTION`으로 원복

### 중요
- <font color="#FFD700"><b>`mode=REGRESSION` 자체가 ES에 저장되지는 않습니다.</b></font>
- ES에는 최종 동의어 규칙 문자열만 저장됩니다.

## 3. 전체 처리 흐름 🔄

1. 클라이언트가 `POST /api/search/reload-synonyms` 호출
2. `mode`를 enum으로 파싱
3. mode에 맞는 동의어 파일 선택
4. 파일 파싱(주석/빈줄 제거)
5. `PUT /_synonyms/{synonymsSet}` 반영
6. `POST /{read-alias}/_reload_search_analyzers` 실행
7. 이후 검색 쿼리부터 반영

## 4. 코드 위치(중요 포인트) 🧩

- 컨트롤러 엔드포인트:
  - `src/main/java/com/example/aisearch/controller/SearchController.java`
- 요청 DTO(mode 파싱 진입점):
  - `src/main/java/com/example/aisearch/controller/dto/ReloadSynonymsRequestDto.java`
- mode enum:
  - `src/main/java/com/example/aisearch/service/synonym/SynonymReloadMode.java`
- 서비스 오케스트레이션:
  - `src/main/java/com/example/aisearch/service/synonym/SynonymReloadService.java`
- 파일 로더(mode에 따른 파일 선택):
  - `src/main/java/com/example/aisearch/service/synonym/FileSynonymRuleSource.java`
- ES 반영 어댑터:
  - `src/main/java/com/example/aisearch/service/synonym/ElasticsearchSynonymEsGateway.java`

## 5. 설정 파일 🛠️

`src/main/resources/application.yml`

```yaml
ai-search:
  synonyms-set: ${AI_SEARCH_SYNONYMS_SET:food-synonyms}
  synonyms-file-path: ${AI_SEARCH_SYNONYMS_FILE_PATH:classpath:es/dictionary/synonyms_ko.txt}
  synonyms-regression-file-path: ${AI_SEARCH_SYNONYMS_REGRESSION_FILE_PATH:classpath:es/dictionary/synonyms_kr_regression.txt}
```

설명:
- `synonyms-set`: ES에 저장할 동의어 세트 이름
- `synonyms-file-path`: 운영 동의어 파일
- `synonyms-regression-file-path`: 회귀 테스트용 파일

## 6. 인덱스/분석기 설정 핵심 🔬

동의어는 검색 시점(search-time)에 적용되도록 구성했습니다.

파일:
- `src/main/resources/es/index-mapping.json`

핵심:
- `ko_synonym_filter` (`synonym_graph`, `synonyms_set`, `updateable: true`)
- `product_name`, `description`에 `search_analyzer` 연결

> [!WARNING]
> 검색 analyzer의 필터 순서는 반드시  
> `lowercase -> ko_synonym_filter -> ko_pos_filter`  
> 이어야 합니다.
>
> <font color="red"><b>순서가 잘못되면 동의어 파싱이 깨져 샤드가 올라오지 않을 수 있습니다.</b></font>

## 7. 실제 장애 사례와 원인 🧯

### 증상
- `/api/search`에서 500 발생
- Bulk 색인 시 `primary shard is not active`

### 원인
- 동의어 규칙(`얇은피`)이 형태소 필터를 먼저 타면서 position increment 오류 발생
- 결과적으로 동의어 파서 실패 -> 샤드 할당 실패

### 핵심 교훈
- <font color="red"><b>포트포워딩/타임아웃으로 보이더라도, 실제 원인은 analyzer 체인 순서일 수 있습니다.</b></font>

## 8. API 사용 예시 📡

### 8.1 회귀 모드 반영

```http
POST /api/search/reload-synonyms
Content-Type: application/json

{
  "mode": "REGRESSION",
  "synonymsSet": "food-synonyms"
}
```

### 8.2 운영 모드 원복

```http
POST /api/search/reload-synonyms
Content-Type: application/json

{
  "mode": "PRODUCTION",
  "synonymsSet": "food-synonyms"
}
```

## 9. 테스트 전략 🧪

### 권장
- 실제 동작 검증: `src/test/java/com/example/aisearch/SynonymsRestClientIntegrationTest.java`
  - API로 동의어 반영 후 실제 검색 결과를 확인
- 검색 기본 검증:
  - `src/test/java/com/example/aisearch/VectorSearchIntegrationTest.java`
  - `src/test/java/com/example/aisearch/SearchControllerRestClientTest.java`

### 참고
- 과거의 mock 기반 `SynonymsTest`는 실제 파일/ES 동작 검증이 약해서 제거했습니다.

## 10. 운영 체크리스트 ✅

- [ ] ES 포트포워딩 및 인증 확인
- [ ] `reload-synonyms` 호출 성공 확인
- [ ] `_cluster/health`, `_cat/indices` 상태 확인
- [ ] 대표 검색어로 결과 확인
- [ ] 문제 시 `_cluster/allocation/explain`으로 샤드 할당 실패 원인 확인

## 11. 기획 의사결정 질문 🧭
- 어떤 단어 묶음을 동의어로 확장할지, 상품 카테고리별 우선순위가 정해져 있는가?
- 잘못된 확장으로 인한 노이즈 검색(과확장)을 어떻게 모니터링할 것인가?
- 동의어 반영 후 검증할 대표 쿼리(성공/실패 케이스)를 사전에 합의했는가?

---

필요하면 다음 단계로, 이 문서에 `curl`/`kubectl` 기반 장애 진단 명령어 모음 섹션을 추가할 수 있습니다. 🔍
