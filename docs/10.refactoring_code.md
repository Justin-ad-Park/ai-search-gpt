# 10. ë¦¬íŒ©í† ë§ ì‘ì—… ì •ë¦¬ (ì´ˆê¸‰ ê°œë°œììš©)

<!-- DOC_STYLE_GUIDE -->
> ğŸ“Œ <font color="#FFD700"><b>í•µì‹¬</b></font>: ì´ ë¬¸ì„œëŠ” ì‹¤ë¬´ ì ìš© ê¸°ì¤€ìœ¼ë¡œ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.
> âš ï¸ <font color="red"><b>ì£¼ì˜</b></font>: ì„¤ì •/ì ˆì°¨ë¥¼ ìƒëµí•˜ë©´ ì¥ì• ë‚˜ í’ˆì§ˆ ì €í•˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> âœ… <font color="green"><b>ê¶Œì¥</b></font>: ì²´í¬ë¦¬ìŠ¤íŠ¸ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•˜ê³  ê²°ê³¼ë¥¼ ë°˜ë“œì‹œ ê²€ì¦í•˜ì„¸ìš”.

ì´ ë¬¸ì„œëŠ” ì‹¤ì œ ì½”ë“œ ë³€ê²½ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ, ë¦¬íŒ©í† ë§ ì „/í›„ë¥¼ ë¹„êµí•˜ë©° ì´ìœ ì™€ íš¨ê³¼ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤.
ê° ì„¹ì…˜ì€ â€œì™œ ë°”ê¿¨ëŠ”ì§€ â†’ ë¬´ì—‡ì´ ë‹¬ë¼ì¡ŒëŠ”ì§€ â†’ ê²°ê³¼â€ ìˆœì„œë¡œ ì½ì„ ìˆ˜ ìˆê²Œ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.
<font color="#FFD700"><b>í•µì‹¬ ë©”ì‹œì§€: ë¦¬íŒ©í† ë§ì˜ ëª©ì ì€ ê¸°ëŠ¥ ì¶”ê°€ë³´ë‹¤ ë³€ê²½ ë¹„ìš©ì„ ì¤„ì´ëŠ” êµ¬ì¡°ë¥¼ ë§Œë“œëŠ” ê²ƒì…ë‹ˆë‹¤.</b></font>

---

## 1) ElasticsearchAutoConnector ì±…ì„ ë¶„ë¦¬

### ì™œ ë°”ê¿¨ë‚˜?
- í•œ í´ë˜ìŠ¤ê°€ **í¬íŠ¸í¬ì›Œë”© íŒë‹¨, kubectl ê²€ì‚¬/í˜¸ì¶œ, ë¹„ë°€ë²ˆí˜¸ ë¡œë”©, URL ì¡°í•©**ê¹Œì§€ ëª¨ë‘ ë‹´ë‹¹í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤.
- ì´ëŸ° êµ¬ì¡°ëŠ” ë³€ê²½ ì´ìœ ê°€ ë§ì•„ì ¸ì„œ ìœ ì§€ë³´ìˆ˜ê°€ ì–´ë ¤ì›Œì§€ê³ , í…ŒìŠ¤íŠ¸ë„ ë³µì¡í•´ì§‘ë‹ˆë‹¤.

### Before (í•µì‹¬ ë¶€ë¶„)
```java
public ConnectionInfo resolve(AiSearchProperties properties, AiSearchK8sProperties k8sProperties) {
    URI uri = URI.create(properties.elasticsearchUrl());
    String username = properties.username();
    String password = properties.password();

    if (!k8sProperties.autoPortForward() || !isLocalHost(uri.getHost())) {
        return new ConnectionInfo(uri.toString(), username, password);
    }

    try {
        ElasticsearchK8sHelper.requireKubectl();

        String namespace = k8sProperties.namespace();
        String serviceName = k8sProperties.serviceName();
        if (serviceName == null || serviceName.isBlank()) {
            serviceName = ElasticsearchK8sHelper.findEsHttpService(namespace);
        }

        if (password == null || password.isBlank() || "password".equals(password)) {
            password = ElasticsearchK8sHelper.readElasticPassword(
                    namespace,
                    k8sProperties.secretName()
            );
            log.info("[ES_AUTO] elastic password loaded from secret {}", k8sProperties.secretName());
        }

        ensurePortForward(namespace, serviceName, k8sProperties.localPort(), k8sProperties.remotePort());
        String scheme = uri.getScheme() == null ? "http" : uri.getScheme();
        String resolvedUrl = scheme + "://localhost:" + k8sProperties.localPort();
        log.info("[ES_AUTO] using port-forwarded url {}", resolvedUrl);
        return new ConnectionInfo(resolvedUrl, username, password);
    } catch (Exception e) {
        log.warn("[ES_AUTO] port-forward failed, falling back to {}", uri, e);
        return new ConnectionInfo(uri.toString(), username, password);
    }
}
```

### After (í•µì‹¬ ë¶€ë¶„)
```java
public ConnectionInfo resolve(AiSearchProperties properties, AiSearchK8sProperties k8sProperties) {
    URI uri = URI.create(properties.elasticsearchUrl());
    String username = properties.username();
    String password = properties.password();

    if (!portForwardDecision.shouldAutoForward(k8sProperties, uri)) {
        return new ConnectionInfo(uri.toString(), username, password);
    }

    try {
        k8sPortForwarder.requireKubectl();

        String namespace = k8sProperties.namespace();
        String serviceName = k8sPortForwarder.resolveServiceName(namespace, k8sProperties.serviceName());

        password = passwordProvider.resolvePassword(namespace, k8sProperties.secretName(), password);

        k8sPortForwarder.ensurePortForward(
                namespace,
                serviceName,
                k8sProperties.localPort(),
                k8sProperties.remotePort()
        );
        String resolvedUrl = urlBuilder.buildLocalUrl(uri, k8sProperties.localPort());
        return new ConnectionInfo(resolvedUrl, username, password);
    } catch (Exception e) {
        log.warn("[ES_AUTO] port-forward failed, falling back to {}", uri, e);
        return new ConnectionInfo(uri.toString(), username, password);
    }
}
```

### ë¬´ì—‡ì´ ì¢‹ì•„ì¡Œë‚˜?
- <font color="green"><b>ì±…ì„ ë¶„ë¦¬(SRP)</b></font>: íŒë‹¨, í¬ì›Œë”©, íŒ¨ìŠ¤ì›Œë“œ ë¡œë”©, URL ìƒì„±ì´ ê°ê° í´ë˜ìŠ¤ë¡œ ë¶„ë¦¬ë¨
- í…ŒìŠ¤íŠ¸í•˜ê¸° ì‰¬ì›€: ì‘ì€ ë‹¨ìœ„ë¡œ êµì²´/ê²€ì¦ ê°€ëŠ¥

ê´€ë ¨ íŒŒì¼:
- `src/main/java/com/example/aisearch/support/PortForwardDecision.java`
- `src/main/java/com/example/aisearch/support/K8sPortForwarder.java`
- `src/main/java/com/example/aisearch/support/ElasticPasswordProvider.java`
- `src/main/java/com/example/aisearch/support/ElasticsearchUrlBuilder.java`

---

## 2) ì„ë² ë”© ëª¨ë¸ ë¡œë”© ì±…ì„ ë¶„ë¦¬

### ì™œ ë°”ê¿¨ë‚˜?
- `DjlEmbeddingService`ê°€ **ëª¨ë¸ ê²½ë¡œ/URL ì„ íƒ**, **ì •ê·œí™”**ê¹Œì§€ ëª¨ë‘ ë‹´ë‹¹í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤.
- ëª¨ë¸ ì„ íƒ ë¡œì§ê³¼ ì„ë² ë”© ì •ê·œí™” ë¡œì§ì€ ë‹¤ë¥¸ ê´€ì‹¬ì‚¬ì´ë¯€ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

### Before (í•µì‹¬ ë¶€ë¶„)
```java
String modelPath = properties.embeddingModelPath();
if (modelPath != null && !modelPath.isBlank() && !"__NONE__".equalsIgnoreCase(modelPath.trim())) {
    Resource resource = resourceLoader.getResource(modelPath);
    var resolvedPath = resource.getFile().toPath();
    log.info("[EMBED_MODEL] using model path: {} -> {}", modelPath, resolvedPath);
    criteria.optModelPath(resolvedPath);
    criteria.optTranslatorFactory(new TextEmbeddingTranslatorFactory());
} else {
    String modelUrl = properties.embeddingModelUrl();
    log.info("[EMBED_MODEL] using model url: {}", modelUrl);
    criteria.optModelUrls(modelUrl);
}

float[] raw = predictRaw(text);
return l2Normalize(raw);
```

### After (í•µì‹¬ ë¶€ë¶„)
```java
EmbeddingModelSource modelSource = modelSourceResolver.load();
if (modelSource.isPathBased()) {
    criteria.optModelPath(modelSource.modelPath());
    if (modelSource.requiresTranslatorFactory()) {
        criteria.optTranslatorFactory(new ai.djl.huggingface.translator.TextEmbeddingTranslatorFactory());
    }
} else {
    criteria.optModelUrls(modelSource.modelUrl());
}

float[] raw = predictRaw(text);
float[] normalized = l2Normalize(raw);
List<Float> values = new ArrayList<>(normalized.length);
for (float value : normalized) {
    values.add(value);
}
return values;
```

### ë¬´ì—‡ì´ ì¢‹ì•„ì¡Œë‚˜?
- <font color="green"><b>ëª¨ë¸ ì†ŒìŠ¤ ì„ íƒ ë¡œì§ì´ ë³„ë„ í´ë˜ìŠ¤ë¡œ ì´ë™ (SRP)</b></font>
- ì •ê·œí™” ì±…ì„ì€ `DjlEmbeddingService` ë‚´ë¶€ ë©”ì„œë“œ(`l2Normalize`)ë¡œ ëª…í™•íˆ ìœ ì§€

ê´€ë ¨ íŒŒì¼:
- `src/main/java/com/example/aisearch/service/embedding/model/EmbeddingModelSourceLoader.java`
- `src/main/java/com/example/aisearch/service/embedding/model/EmbeddingModelSource.java`
- `src/main/java/com/example/aisearch/service/embedding/DjlEmbeddingService.java`

---

## 3) ìƒ‰ì¸ íŒŒì´í”„ë¼ì¸ ë¶„ë¦¬

### ì™œ ë°”ê¿¨ë‚˜?
- `ProductIndexingService`ê°€ **ë¬¸ì„œ ë§¤í•‘, ë²Œí¬ ì¸ë±ì‹± ì‹¤í–‰**ê¹Œì§€ ë‹´ë‹¹í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤.
- ìƒ‰ì¸ ë¬¸ì„œ í˜•íƒœê°€ ë°”ë€Œë©´ ì„œë¹„ìŠ¤ ì „ì²´ê°€ ê°™ì´ ë³€ê²½ë©ë‹ˆë‹¤.

### Before (í•µì‹¬ ë¶€ë¶„)
```java
BulkRequest.Builder bulkBuilder = new BulkRequest.Builder().index(properties.indexName());

for (FoodProduct food : foods) {
    float[] embedding = embeddingService.embed(food.toEmbeddingText());
    List<Float> vector = toFloatList(embedding);

    Map<String, Object> doc = new HashMap<>();
    doc.put("id", food.getId());
    doc.put("product_name", food.getProductName());
    doc.put("category", food.getCategory());
    doc.put("description", food.getDescription());
    doc.put("product_vector", vector);

    bulkBuilder.operations(op -> op
            .index(idx -> idx
                    .id(food.getId())
                    .document(doc)
            )
    );
}

var response = client.bulk(bulkBuilder.refresh(Refresh.WaitFor).build());
```

### After (í•µì‹¬ ë¶€ë¶„)
```java
List<IndexDocument> documents = foods.stream()
        .map(food -> documentMapper.toIndexDocument(
                food,
                embeddingService.toEmbeddingVector(food.toEmbeddingText())
        ))
        .collect(Collectors.toList());

return bulkIndexingExecutor.bulkIndex(properties.indexName(), documents);
```

### ë¬´ì—‡ì´ ì¢‹ì•„ì¡Œë‚˜?
- ë¬¸ì„œ ë³€í™˜ ë¡œì§ê³¼ ES ì‹¤í–‰ ë¡œì§ì´ ë¶„ë¦¬ë¨
- ìƒ‰ì¸ êµ¬ì¡° ë³€ê²½ì´ ì‰¬ì›€
- <font color="red"><b>ìƒ‰ì¸ íŒŒì´í”„ë¼ì¸ì„ í•œ í´ë˜ìŠ¤ì— ë‹¤ì‹œ í•©ì¹˜ë©´, ë³€ê²½ ì˜í–¥ ë²”ìœ„ê°€ ë‹¤ì‹œ ì»¤ì§‘ë‹ˆë‹¤.</b></font>

ê´€ë ¨ íŒŒì¼:
- `src/main/java/com/example/aisearch/service/indexing/bootstrap/ingest/FoodProductDocumentMapper.java`
- `src/main/java/com/example/aisearch/service/indexing/bootstrap/ingest/BulkIndexingExecutor.java`
- `src/main/java/com/example/aisearch/service/indexing/bootstrap/ingest/IndexDocument.java`

---

## 4) ê²€ìƒ‰ ì „ëµ(Strategy) ë¶„ë¦¬

### ì™œ ë°”ê¿¨ë‚˜?
- `ProductSearchService`ê°€ ê²€ìƒ‰ êµ¬í˜„ê¹Œì§€ ì§ì ‘ ê°–ê³  ìˆì–´ í™•ì¥ì´ ì–´ë ¤ì› ìŠµë‹ˆë‹¤.
- í–¥í›„ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰, í•„í„° ê¸°ë°˜ ê²€ìƒ‰ ë“±ì„ ë„£ê¸° ì–´ë ¤ìš´ êµ¬ì¡°ì˜€ìŠµë‹ˆë‹¤.

### Before (í•µì‹¬ ë¶€ë¶„)
```java
SearchResponse<Map> response = client.search(s -> s
        .index(properties.indexName())
        .knn(knn -> knn
                .field("product_vector")
                .queryVector(queryVector)
                .k((long) size)
                .numCandidates(numCandidates)
        )
        .size(size),
        Map.class
);
```

### After (í•µì‹¬ ë¶€ë¶„)
```java
public SearchPageResult searchPage(ProductSearchRequest searchRequest, Pageable pageable) {
    return searchStrategy.search(searchRequest, pageable);
}
```

### ë¬´ì—‡ì´ ì¢‹ì•„ì¡Œë‚˜?
- ê²€ìƒ‰ êµ¬í˜„ì„ êµì²´í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°(Strategy íŒ¨í„´)
- ì„œë¹„ìŠ¤ëŠ” â€œë¬´ì—‡ì„ í• ì§€â€ë§Œ ì•Œê³  â€œì–´ë–»ê²Œ í• ì§€â€ëŠ” ì „ëµì´ ë‹´ë‹¹

ê´€ë ¨ íŒŒì¼:
- `src/main/java/com/example/aisearch/service/search/ProductSearchService.java`
- `src/main/java/com/example/aisearch/service/search/strategy/SearchStrategy.java`
- `src/main/java/com/example/aisearch/service/search/strategy/KnnSearchStrategy.java`

---

## 5) ì¸ë±ìŠ¤ ë§¤í•‘ í…œí”Œë¦¿ ì™¸ë¶€í™”

### ì™œ ë°”ê¿¨ë‚˜?
- ë§¤í•‘ JSONì´ ì½”ë“œ ë¬¸ìì—´ë¡œ ë“¤ì–´ ìˆì–´ ìˆ˜ì •ì´ ì–´ë ¤ì› ìŠµë‹ˆë‹¤.
- JSON ë³€ê²½ ì‹œ ì½”ë“œ ìˆ˜ì •/ì»´íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤.

### Before (í•µì‹¬ ë¶€ë¶„)
```java
return """
        {
          "settings": {
            "number_of_shards": 1,
            "number_of_replicas": 0
          },
          "mappings": {
            "properties": {
              "id": {"type": "keyword"},
              "product_name": {"type": "text"},
              "category": {"type": "keyword"},
              "description": {"type": "text"},
              "product_vector": {
                "type": "dense_vector",
                "dims": %d,
                "index": true,
                "similarity": "cosine"
              }
            }
          }
        }
        """.formatted(vectorDimensions);
```

### After (í•µì‹¬ ë¶€ë¶„)
```java
String template = loadTemplate();
return template.replace(DIMS_PLACEHOLDER, String.valueOf(vectorDimensions));
```

```json
{
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 0
  },
  "mappings": {
    "properties": {
      "id": {"type": "keyword"},
      "product_name": {"type": "text"},
      "category": {"type": "keyword"},
      "description": {"type": "text"},
      "product_vector": {
        "type": "dense_vector",
        "dims": __DIMS__,
        "index": true,
        "similarity": "cosine"
      }
    }
  }
}
```

### ë¬´ì—‡ì´ ì¢‹ì•„ì¡Œë‚˜?
- JSON ìˆ˜ì •ì´ ì‰¬ì›Œì§ (ë¦¬ì†ŒìŠ¤ íŒŒì¼ë§Œ ìˆ˜ì •)
- ì½”ë“œ ê°€ë…ì„± í–¥ìƒ

ê´€ë ¨ íŒŒì¼:
- `src/main/java/com/example/aisearch/service/indexing/bootstrap/schema/IndexSchemaBuilder.java`
- `src/main/resources/es/index-mapping.json`

---

## 6) ë°°ì¹˜ ì „ìš© ì—”íŠ¸ë¦¬ ì •ë¦¬ (í”„ë¡œíŒŒì¼ ê¸°ë°˜)

### ì™œ ë°”ê¿¨ë‚˜?
- ë³„ë„ì˜ ë©”ì¸ í´ë˜ìŠ¤ê°€ ì¡´ì¬í•˜ë©´ ì‹¤í–‰ ê²½ë¡œê°€ ëŠ˜ì–´ë‚˜ê³  ê´€ë¦¬ê°€ ì–´ë ¤ì›Œì§‘ë‹ˆë‹¤.
- Spring Profileë¡œ êµ¬ë™ ì˜µì…˜ë§Œ ë¶„ë¦¬í•˜ë©´ ìœ ì§€ë³´ìˆ˜ê°€ ì‰½ìŠµë‹ˆë‹¤.

### Before (í•µì‹¬ ë¶€ë¶„)
ë³„ë„ì˜ ë°°ì¹˜ ì „ìš© ë©”ì¸ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´, ì‹œìŠ¤í…œ í”„ë¡œí¼í‹°ë¥¼ ì§ì ‘ ì£¼ì…í•˜ê³  ì›¹ ì„œë²„ë¥¼ ë¹„í™œì„±í™”í–ˆìŠµë‹ˆë‹¤.
```java
public class IndexingApplication {
    public static void main(String[] args) {
        System.setProperty("ai-search.bootstrap-index", "true");
        SpringApplication application = new SpringApplication(AiSearchGptApplication.class);
        application.setWebApplicationType(WebApplicationType.NONE);
        application.run(args);
    }
}
```

### After (í•µì‹¬ ë¶€ë¶„)
ë©”ì¸ í´ë˜ìŠ¤ëŠ” `AiSearchGptApplication` í•˜ë‚˜ë§Œ ìœ ì§€í•˜ê³ , ë°°ì¹˜ ì‹¤í–‰ì— í•„ìš”í•œ ì˜µì…˜ì€ í”„ë¡œíŒŒì¼ ì„¤ì •ìœ¼ë¡œ ë¶„ë¦¬í–ˆìŠµë‹ˆë‹¤.
```java
@SpringBootApplication
@EnableConfigurationProperties({AiSearchProperties.class, AiSearchK8sProperties.class})
public class AiSearchGptApplication {
    public static void main(String[] args) {
        SpringApplication.run(AiSearchGptApplication.class, args);
    }
}
```

```yaml
# application-indexing.yml
ai-search:
  bootstrap-index: true

spring:
  main:
    web-application-type: none
```

### ë¬´ì—‡ì´ ì¢‹ì•„ì¡Œë‚˜?
- ì‹¤í–‰ ë°©ë²•ì´ ì„¤ì •ìœ¼ë¡œ í†µì¼ë¨
- ë©”ì¸ í´ë˜ìŠ¤ ìˆ˜ ê°ì†Œ
- ë°°ì¹˜ ì‹¤í–‰ ì—¬ë¶€ë¥¼ ì½”ë“œê°€ ì•„ë‹Œ ì„¤ì •ìœ¼ë¡œ ì œì–´ (í™˜ê²½ë³„ ì „í™˜ ìš©ì´)

ì‹¤í–‰ ì˜ˆì‹œ:
```
SPRING_PROFILES_ACTIVE=indexing ./gradlew bootRun
```

---

## ì •ë¦¬
- ë¦¬íŒ©í† ë§ì˜ í•µì‹¬ì€ **â€œì±…ì„ì„ ì‘ê²Œ ë‚˜ëˆ„ê³ , ë³€ê²½ ì´ìœ ë¥¼ ë¶„ë¦¬í•˜ëŠ” ê²ƒâ€**ì…ë‹ˆë‹¤.
- <font color="#FFD700"><b>ì¦‰, ìœ ì§€ë³´ìˆ˜ ë‚œì´ë„ë¥¼ ë‚®ì¶”ëŠ” êµ¬ì¡°ì  íˆ¬ìì…ë‹ˆë‹¤.</b></font>
- ì½”ë“œê°€ ê¸¸ì–´ì§€ëŠ” ëŒ€ì‹  ì´í•´í•˜ê¸° ì‰¬ì›Œì§€ê³ , í…ŒìŠ¤íŠ¸/í™•ì¥ì´ ì‰¬ì›Œì§‘ë‹ˆë‹¤.
