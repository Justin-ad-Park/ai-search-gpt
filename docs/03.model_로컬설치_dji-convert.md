# 03. 로컬 임베딩 모델 설치 가이드 (djl-convert)

## 대상 독자
- 주니어 개발자

## 3줄 요약
- `djl-convert`로 Hugging Face 모델을 로컬 폴더로 변환할 수 있습니다.
- 결과 폴더를 `src/main/resources/model/...` 아래에 두고 `optModelPath`로 로딩합니다.
- 모델 교체 후에는 임베딩 차원 확인과 재색인 검증이 필수입니다.

## 1. 선행 조건
- Python 3.11+
- `pip` 사용 가능
- Java 애플리케이션 실행 환경(Gradle)

확인 명령:
```bash
python3 --version
python3 -m pip --version
```

## 2. 설치
권장 경로는 공식 휠 설치 1가지입니다.

```bash
python3 -m pip install --user \
  https://publish.djl.ai/djl_converter/djl_converter-0.30.0-py3-none-any.whl
```

PATH에 사용자 로컬 바이너리가 없으면 1회 추가:
```bash
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc
```

설치 확인:
```bash
djl-convert --help
```

## 3. 모델 변환
예시 모델: `dragonkue/multilingual-e5-small-ko-v2`

```bash
mkdir -p ~/tmp/djl-models
cd ~/tmp/djl-models
djl-convert -m dragonkue/multilingual-e5-small-ko-v2
```

## 4. 결과물 위치
변환이 끝나면 기본적으로 아래 구조가 생성됩니다.

```text
~/tmp/djl-models/model/dragonkue/multilingual-e5-small-ko-v2/
```

프로젝트 반영 경로(권장):
```text
src/main/resources/model/multilingual-e5-small-ko-v2/
```

복사:
```bash
cp -R ~/tmp/djl-models/model/dragonkue/multilingual-e5-small-ko-v2 \
  src/main/resources/model/
```

## 5. 앱 설정 반영
`DjlEmbeddingService`에서 로딩 방식을 URL 기반(`optModelUrls`)에서 로컬 경로 기반(`optModelPath`)으로 전환합니다.

대상 코드:
- `src/main/java/com/example/aisearch/service/embedding/DjlEmbeddingService.java`

예시:
```java
Criteria<String, float[]> criteria = Criteria.builder()
    .setTypes(String.class, float[].class)
    .optApplication(Application.NLP.TEXT_EMBEDDING)
    .optModelPath(Paths.get("src/main/resources/model/multilingual-e5-small-ko-v2"))
    .optProgress(new ProgressBar())
    .build();
```

## 6. 검증
1. 애플리케이션 기동 시 모델 초기화 로그 확인
- 예: `Embedding model initialized. dimensions=384`

2. 색인 실행 후 검색 검증
```bash
./gradlew bootRun --args='--spring.profiles.active=indexing'
```

3. 기본 검색 테스트 실행
```bash
./sh_bin/04_run_vector_search_test_local.sh
```

## 7. 트러블슈팅
- `djl-convert: command not found`
  - `~/.local/bin` PATH 반영 여부 확인
- 모델 로딩 실패
  - `optModelPath` 경로 오탈자 확인
  - `model/` 하위 파일(`config.json`, `tokenizer.json`, `serving.properties`) 존재 확인
- 검색 품질 저하
  - 모델 변경 후 재색인 누락 여부 확인

## 체크리스트
- [ ] `djl-convert` 설치 완료
- [ ] 모델 변환/복사 완료 (`src/main/resources/model/...`)
- [ ] `DjlEmbeddingService` 로컬 경로 로딩 설정 반영
- [ ] 임베딩 차원 로그 확인
- [ ] 재색인 + 검색 검증 완료
