# 03. ë¡œì»¬ ì„ë² ë”© ëª¨ë¸ ì„¤ì¹˜ ê°€ì´ë“œ (djl-convert)

<!-- DOC_STYLE_GUIDE -->
> ğŸ“Œ <font color="blue"><b>í•µì‹¬</b></font>: ì´ ë¬¸ì„œëŠ” ì‹¤ë¬´ ì ìš© ê¸°ì¤€ìœ¼ë¡œ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.
> âš ï¸ <font color="red"><b>ì£¼ì˜</b></font>: ì„¤ì •/ì ˆì°¨ë¥¼ ìƒëµí•˜ë©´ ì¥ì• ë‚˜ í’ˆì§ˆ ì €í•˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> âœ… <font color="green"><b>ê¶Œì¥</b></font>: ì²´í¬ë¦¬ìŠ¤íŠ¸ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•˜ê³  ê²°ê³¼ë¥¼ ë°˜ë“œì‹œ ê²€ì¦í•˜ì„¸ìš”.

## ëŒ€ìƒ ë…ì
- ì£¼ë‹ˆì–´ ê°œë°œì

## 3ì¤„ ìš”ì•½
- `djl-convert`ë¡œ Hugging Face ëª¨ë¸ì„ ë¡œì»¬ í´ë”ì— ë¹Œë“œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- <font color="blue"><b>ê²°ê³¼ í´ë”ë¥¼ `src/main/resources/model/...` ì•„ë˜ì— ë‘ê³  `optModelPath`ë¡œ ë¡œë”©í•©ë‹ˆë‹¤.</b></font>
- <font color="red"><b>ëª¨ë¸ êµì²´ í›„ì—ëŠ” ì„ë² ë”© ì°¨ì› í™•ì¸ê³¼ ì¬ìƒ‰ì¸ ê²€ì¦ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.</b></font>

## 1. ì„ í–‰ ì¡°ê±´
- Python 3.11+
- `pip` ì‚¬ìš© ê°€ëŠ¥
- Java ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ í™˜ê²½(Gradle)

í™•ì¸ ëª…ë ¹:
```bash

python3 --version
python3 -m pip --version
```

## 2. ì„¤ì¹˜
<font color="green"><b>ê¶Œì¥ ê²½ë¡œëŠ” ê³µì‹ íœ  ì„¤ì¹˜ 1ê°€ì§€ì…ë‹ˆë‹¤.</b></font>
- ê¶Œì¥ ê²½ë¡œ = íŒ€ í‘œì¤€ ì„¤ì¹˜ ë°©ë²•
- ê³µì‹ íœ  = DJLì—ì„œ ë°°í¬í•œ wheel íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë°©ì‹


```bash
 
python3 -m pip install --user \
  https://publish.djl.ai/djl_converter/djl_converter-0.30.0-py3-none-any.whl
```

PATHì— ì‚¬ìš©ì ë¡œì»¬ ë°”ì´ë„ˆë¦¬ê°€ ì—†ìœ¼ë©´ 1íšŒ ì¶”ê°€:
```bash

echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc
```

ì„¤ì¹˜ í™•ì¸:
```bash

djl-convert --help
```

## 3. ëª¨ë¸ ë³€í™˜
ì˜ˆì‹œ ëª¨ë¸: `dragonkue/multilingual-e5-small-ko-v2`

```bash

mkdir -p ~/tmp/djl-models
cd ~/tmp/djl-models
djl-convert -m dragonkue/multilingual-e5-small-ko-v2
```

## 4. ê²°ê³¼ë¬¼ ìœ„ì¹˜
ë³€í™˜ì´ ëë‚˜ë©´ ê¸°ë³¸ì ìœ¼ë¡œ ì•„ë˜ êµ¬ì¡°ê°€ ìƒì„±ë©ë‹ˆë‹¤.

```text
~/tmp/djl-models/model/dragonkue/multilingual-e5-small-ko-v2/
```

<font color="green"><b>í”„ë¡œì íŠ¸ ë°˜ì˜ ê²½ë¡œ(ê¶Œì¥):</b></font>
```text
src/main/resources/model/multilingual-e5-small-ko-v2/
```

ë³µì‚¬:
```bash

cp -R ~/tmp/djl-models/model/dragonkue/multilingual-e5-small-ko-v2 \
  src/main/resources/model/
```

## 5. ì•± ì„¤ì • ë°˜ì˜
`DjlEmbeddingService`ì—ì„œ ë¡œë”© ë°©ì‹ì„ URL ê¸°ë°˜(`optModelUrls`)ì—ì„œ ë¡œì»¬ ê²½ë¡œ ê¸°ë°˜(`optModelPath`)ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.

ëŒ€ìƒ ì½”ë“œ:
- `src/main/java/com/example/aisearch/service/embedding/DjlEmbeddingService.java`

ì˜ˆì‹œ:
```java
Criteria<String, float[]> criteria = Criteria.builder()
    .setTypes(String.class, float[].class)
    .optApplication(Application.NLP.TEXT_EMBEDDING)
    .optModelPath(Paths.get("src/main/resources/model/multilingual-e5-small-ko-v2"))
    .optProgress(new ProgressBar())
    .build();
```

## 6. ê²€ì¦
1. ì• í”Œë¦¬ì¼€ì´ì…˜ ê¸°ë™ ì‹œ ëª¨ë¸ ì´ˆê¸°í™” ë¡œê·¸ í™•ì¸
- ì˜ˆ: `Embedding model initialized. dimensions=384`

2. ìƒ‰ì¸ ì‹¤í–‰ í›„ ê²€ìƒ‰ ê²€ì¦
```bash
./gradlew bootRun --args='--spring.profiles.active=indexing'
```

3. ê¸°ë³¸ ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
```bash

./sh_bin/04_run_vector_search_test_local.sh
```

## 7. íŠ¸ëŸ¬ë¸”ìŠˆíŒ…
- `djl-convert: command not found`
  - `~/.local/bin` PATH ë°˜ì˜ ì—¬ë¶€ í™•ì¸
- ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨
  - `optModelPath` ê²½ë¡œ ì˜¤íƒˆì í™•ì¸
  - `model/` í•˜ìœ„ íŒŒì¼(`config.json`, `tokenizer.json`, `serving.properties`) ì¡´ì¬ í™•ì¸
- ê²€ìƒ‰ í’ˆì§ˆ ì €í•˜
  - <font color="red"><b>ëª¨ë¸ ë³€ê²½ í›„ ì¬ìƒ‰ì¸ ëˆ„ë½ ì—¬ë¶€ í™•ì¸</b></font>

## ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] `djl-convert` ì„¤ì¹˜ ì™„ë£Œ
- [ ] ëª¨ë¸ ë³€í™˜/ë³µì‚¬ ì™„ë£Œ (`src/main/resources/model/...`)
- [ ] `DjlEmbeddingService` ë¡œì»¬ ê²½ë¡œ ë¡œë”© ì„¤ì • ë°˜ì˜
- [ ] ì„ë² ë”© ì°¨ì› ë¡œê·¸ í™•ì¸
- [ ] ì¬ìƒ‰ì¸ + ê²€ìƒ‰ ê²€ì¦ ì™„ë£Œ
