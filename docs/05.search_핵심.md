# 06. search 핵심 정리

이 문서는 `KnnSearchStrategy`의 `search` 메서드 중 **람다(함수형 인터페이스) 기반 검색 요청 구성**이 어떻게 동작하는지 초보 개발자도 이해할 수 있도록 설명합니다.

---

## 1) 함수형 인터페이스(람다) 설명

### 왜 람다가 쓰였나?
Elasticsearch Java Client는 **빌더 패턴**을 많이 사용합니다. 이때 빌더를 매번 new 해서 길게 쓰기보다, **람다를 통해 간결하게 빌더를 구성**하도록 설계되어 있습니다.

예를 들어 아래 코드는:

```java
client.search(s -> s.index("my-index"), Map.class);
```

다음과 같은 의미입니다:
- `s`는 **SearchRequest.Builder** 역할을 하는 빌더
- `s -> ...` 람다는 **SearchRequest.Builder를 어떻게 채울지** 알려주는 함수

즉, 람다는 **"요청 객체를 만드는 로직"**을 함수처럼 넘기는 방식입니다.

### 함수형 인터페이스란?
자바에서 **메서드가 하나만 있는 인터페이스**를 함수형 인터페이스라고 합니다.
람다는 그 메서드 구현을 **짧게 작성하는 문법**이에요.

예시:
```java
Function<Integer, Integer> square = x -> x * x;
```

Elasticsearch Java Client에서는 이런 함수형 인터페이스를 통해 **요청 빌더를 구성**하게 합니다.

---

## 2) 실제 검색 코드 해석

아래 코드를 한 줄씩 풀어 설명합니다.

```java
SearchResponse<Map> response = client.search(s -> s
        .index(properties.indexName())
        .knn(knn -> knn
                .field("product_vector")
                .queryVector(queryVector)
                .k((long) size)
                .numCandidates(numCandidates)
        )
        .size(size),
        Map.class
);
```

### 1) `client.search(...)`
- Elasticsearch에 **검색 요청을 실행**한다.
- 첫 번째 인자는 **요청을 어떻게 만들지**를 정의하는 람다.
- 두 번째 인자는 `_source`를 어떤 타입으로 받을지 지정 (여기서는 `Map`).

### 2) `s -> s.index(...)`
- `s`는 **SearchRequest.Builder** 역할.
- `.index(...)`는 검색할 **인덱스 이름**을 지정한다.

### 3) `.knn(knn -> ...)`
- 이 요청은 **벡터 검색(kNN 검색)**을 수행한다.
- 내부 `knn`은 **KnnSearch.Builder** 역할.

### 4) `.field("product_vector")`
- 문서의 **어떤 벡터 필드로** 유사도 검색할지 지정.
- 매핑에서 `product_vector`는 `dense_vector`로 정의돼 있어야 함.

### 5) `.queryVector(queryVector)`
- 검색어를 임베딩한 결과 벡터.
- 이 벡터와 문서 벡터의 **코사인 유사도**가 계산됨.

### 6) `.k((long) size)`
- 최종 결과로 **가져올 문서 개수**(Top-K).
- `size=5`면 가장 유사한 5개 문서.

### 7) `.numCandidates(numCandidates)`
- 검색할 때 **후보군으로 평가할 문서 수**.
- `k`보다 크게 잡아야 검색 품질이 좋아짐.
- 예: `k=5`, `numCandidates=50`

### 8) `.size(size)`
- 실제 응답으로 반환할 **히트 수 제한**.
- 보통 `k`와 동일하게 맞춘다.

### 9) `Map.class`
- Elasticsearch `_source`를 `Map<String, Object>`로 받겠다는 뜻.
- JSON을 동적으로 다루기 쉬움.

---

## 3) 요약 (한 문장)

이 코드는 **queryVector와 가장 유사한 문서를 size개 찾기 위해 kNN 검색을 수행하고**,
그 과정에서 품질을 높이기 위해 **numCandidates만큼 후보군을 넉넉히 평가**하도록 요청한다.

---

## 4) 초보 개발자 체크 포인트

- `s -> s`와 `knn -> knn`은 **요청을 만드는 빌더 람다**다.
- `k`는 최종 결과 개수, `numCandidates`는 평가 후보 개수다.
- `_source`를 `Map`으로 받으면 편하지만 타입 안정성은 떨어진다.

