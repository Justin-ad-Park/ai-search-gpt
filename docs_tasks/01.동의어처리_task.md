# 07. 동의어 처리

## 목적
- 운영 중 동의어를 빠르게 갱신하고, 검색 결과에 즉시 반영한다.
- 예: `만두, 교자, 얇은피, 얄피`를 동의어로 관리해 `얇은피` 검색 시 만두 상품도 검색되게 한다.

## 적용 전제 (버전/클러스터)
- `synonyms_set` API와 `_reload_search_analyzers`를 사용하므로 Elasticsearch `8.10+`를 기준으로 한다.
- 클러스터는 동의어 갱신 API 호출이 가능한 상태(health yellow/green)여야 한다.
- 애플리케이션에서 대상 인덱스와 동의어 세트 ID를 설정값으로 주입할 수 있어야 한다.

## 구현 가이드 (간단 버전)
- 책임 분리: Controller는 요청/응답, Service는 동의어 반영 흐름, ES Client는 외부 호출만 담당한다.
- 확장 포인트 최소화: 동의어 소스(운영/회귀 파일 선택)만 분리하고, 나머지는 단일 서비스 흐름으로 유지한다.
- 설정 외부화: `synonymsSet`, `index`, 파일 경로는 `application.yml`로 관리한다.
- 실패 원인 분리: 파일 파싱 실패(`400`)와 ES 반영 실패(`500`)를 구분해 반환한다.

## 핵심 원칙
- `synonyms_ko.txt`는 관리자가 편집하는 원본 파일(Source of Truth)이다.
- Elasticsearch 반영은 파일 경로 직접 참조가 아니라 `synonyms_set` API를 사용한다.
- 운영 순서는 `파일 수정 -> API 반영 -> analyzer reload -> 검색 검증`으로 고정한다.

## 1. 파일 준비
### 1.1 운영 동의어 파일
- 위치: `src/main/resources/es/dictionary/synonyms_ko.txt`

예시 규칙:
```text
만두, 교자, 얇은피, 얄피
```

### 1.2 회귀 테스트용 동의어 파일
- 위치: `src/main/resources/es/dictionary/synonyms_kr_regression.txt`
- 목적: 운영 파일(`synonyms_ko.txt`)을 직접 수정하지 않고 테스트 시나리오를 검증

예시 규칙(회귀 테스트):
```text
만두, 딤섬
```

## 2. 테스트 데이터 준비
- 파일: `src/main/resources/data/food-products.json`
- 회귀 테스트 검증을 위해 생만두 상품 데이터를 포함한다.
- 예시(핵심 문구):
  - `productName`: 생만두 또는 만두 관련 명칭
  - `description`: `설에 끓여 먹는 생만두` 문구 포함

## 3. Elasticsearch 적용 방식
### 3.1 동의어 세트 생성/수정
```bash
curl -u elastic:${PASSWORD} -X PUT "http://localhost:9200/_synonyms/food-synonyms" \
  -H "Content-Type: application/json" \
  -d '{
    "synonyms_set": [
      { "id": "mandu-1", "synonyms": "만두, 교자, 얇은피, 얄피" }
    ]
  }'
```

### 3.2 analyzer 설정 조건
- `synonym_graph` 필터에서 `synonyms_set` 참조
- `updateable: true` 사용
- 검색 analyzer(`search_analyzer`)에 연결

예시(index settings + mapping):
```json
PUT /ai-search-products
{
  "settings": {
    "analysis": {
      "filter": {
        "ko_synonym_filter": {
          "type": "synonym_graph",
          "synonyms_set": "food-synonyms",
          "updateable": true
        }
      },
      "analyzer": {
        "ko_index_analyzer": {
          "type": "custom",
          "tokenizer": "nori_tokenizer",
          "filter": ["lowercase"]
        },
        "ko_search_synonym_analyzer": {
          "type": "custom",
          "tokenizer": "nori_tokenizer",
          "filter": ["lowercase", "ko_synonym_filter"]
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "productName": {
        "type": "text",
        "analyzer": "ko_index_analyzer",
        "search_analyzer": "ko_search_synonym_analyzer"
      },
      "description": {
        "type": "text",
        "analyzer": "ko_index_analyzer",
        "search_analyzer": "ko_search_synonym_analyzer"
      }
    }
  }
}
```

### 3.3 즉시 반영
```bash
curl -u elastic:${PASSWORD} -X POST "http://localhost:9200/<index-name>/_reload_search_analyzers"
```

### 3.4 검색 로직 반영 체크리스트(필수)
- 동의어 처리는 검색 시점 확장이므로, 검색 대상 필드 매핑에 `search_analyzer`가 반드시 연결되어 있어야 한다.
- 검색 쿼리(`match`, `multi_match` 등)는 해당 필드를 사용하도록 유지한다.
- 쿼리에서 analyzer를 직접 지정하는 구조라면 동의어 analyzer를 명시해야 한다.
- 벡터 검색과 키워드 검색을 함께 쓰는 경우에도, 키워드 절(query 절)은 동의어 analyzer가 적용되는 필드를 사용해야 한다.
- 위 조건이 충족되지 않으면 `reload-synonyms`를 호출해도 검색 결과에는 반영되지 않는다.
- 적용 필드 범위(기본): `productName`, `description`

## 4. SearchController 연계 (`reloadSynonyms`)
- 권장 엔드포인트: `POST /api/search/reload-synonyms`
- 서버 처리 순서:
1. 요청값에 따라 동의어 파일 선택(`synonyms_ko.txt` 또는 `synonyms_kr_regression.txt`)
2. 주석/빈 줄 제거
3. `PUT /_synonyms/{set_id}` 호출
4. `POST /{read-alias}/_reload_search_analyzers` 호출
5. 결과 응답 반환

### 4.1 요청/응답 스펙
요청 예시:
```json
{
  "mode": "REGRESSION",
  "synonymsSet": "food-synonyms"
}
```

요청 규칙:
- `mode`: `REGRESSION` | `PRODUCTION`
- `REGRESSION`이면 `synonyms_kr_regression.txt` 사용
- `PRODUCTION`이면 `synonyms_ko.txt` 사용
- `synonymsSet` 미입력 시 서버 기본값 사용 가능

성공 응답 예시:
```json
{
  "updated": true,
  "reloaded": true,
  "mode": "REGRESSION",
  "synonymsSet": "food-synonyms",
  "index": "food-products-read",
  "ruleCount": 1,
  "message": "synonyms reloaded successfully"
}
```

실패 응답 규약:
- `400 Bad Request`
  - 요청 파라미터 오류, 파일 모드/값 오류, 동의어 규칙 파싱 실패
  - 예시 `message`: `invalid reload mode: XXX`
- `500 Internal Server Error`
  - Elasticsearch 반영 실패, analyzer reload 실패
  - 예시 `message`: `failed to reload analyzers for index food-products-read`

### 구현 배치 가이드 (OOP)
1. `SearchController`는 `reloadSynonyms` 요청을 받아 서비스만 호출한다.
2. `SynonymReloadService`는 "파일 로드 -> 변환 -> ES 반영 -> analyzer reload" 오케스트레이션만 담당한다.
3. 동의어 파일 선택(운영/회귀)은 서비스 내부 전략으로 단순화해 관리한다.

## 5. 테스트 케이스

### 5.1 회귀 테스트(먼저 수행)
- 절차:
1. `mode=REGRESSION`으로 `POST /api/search/reload-synonyms` 호출
2. `q=딤섬` 검색 실행
3. 생만두 상품 노출 여부 확인
- 검증 포인트:
1. 동의어 규칙 `만두, 딤섬`이 반영되어 `q=딤섬`에서 생만두가 검색되는지
2. 애플리케이션 재시작 없이 반영되는지

### 5.2 운영 동의어 적용 테스트(회귀 테스트 이후)
- 절차:
1. `mode=PRODUCTION`으로 `POST /api/search/reload-synonyms` 호출(운영 동의어 원복)
2. `q=얇은피`, `q=얄피`, `q=만두`, `q=교자` 검색 실행
- 검증 포인트:
1. 동의어 규칙 `만두, 교자, 얇은피, 얄피`가 정상 반영되는지
2. 회귀 테스트용 규칙(`만두, 딤섬`)이 운영 검색에 남지 않는지

### 5.3 동의어 리로드 API 테스트
- 대상: `POST /api/search/reload-synonyms`
- 검증 포인트:
1. 응답 코드 `200`
2. 응답 필드 `updated=true`, `reloaded=true`
3. `synonymsSet` 값이 기대값(`food-synonyms`)인지 확인
4. `mode` 값에 따라 파일 선택이 올바른지 확인

### 5.4 자동화 테스트 (`SynonymsTest`) 추가
- 테스트 클래스: `src/test/java/.../SynonymsTest`
- 권장 시나리오:
1. `reloadSynonyms_regressionMode_appliesManduTteokgukRules`
2. `reloadSynonyms_productionMode_restoresDefaultRules`
3. `search_tteokguk_returnsSaengMandu_afterRegressionReload`
4. `search_yalpi_or_mandu_returnsMandu_afterProductionReload`
5. `reloadSynonyms_returns400_whenModeInvalid`
6. `reloadSynonyms_returns500_whenElasticsearchCallFails`
- 실행 명령 예시:
```bash
./gradlew test --tests "*SynonymsTest"
```

## 6. 운영 절차
1. 회귀 검증: `mode=REGRESSION`으로 `POST /api/search/reload-synonyms` 호출
2. `q=딤섬` 검색으로 생만두 노출 확인
3. 운영 반영(원복): `mode=PRODUCTION`으로 `POST /api/search/reload-synonyms` 호출
4. `q=얇은피`, `q=얄피`, `q=교자`, `q=만두` 검색 확인

## 7. 주의사항
- 동의어는 search-time 확장이므로 재색인 없이 운영 반영 가능하다.
- analyzer가 `synonyms_set` 기반으로 구성되어 있지 않으면 위 절차가 동작하지 않는다.
- 회귀 테스트는 운영 파일 직접 수정 대신 테스트용 파일(`synonyms_kr_regression.txt`)로 수행한다.
